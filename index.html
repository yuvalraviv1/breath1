<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Breath Monitor Prototype</title>
<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<style>
body { font-family: Arial, sans-serif; margin: 40px; }
#values { margin-top: 20px; font-size: 1.2em; }
#debug-canvas { display: block; margin-top: 20px; background: #eee; border: 1px solid #ccc; }
</style>
</head>
<body>
<h1>Breath Monitor Prototype</h1>
<p id="status">Awaiting permission for motion sensors...</p>
<div id="values">
X: <span id="x">0</span><br>
Y: <span id="y">0</span><br>
Z: <span id="z">0</span>
</div>
<div id="settings" style="margin-top:20px;">
    <label>Sample interval (ms):
        <input type="number" id="sample-interval" value="5" min="1" step="1">
    </label>
    <br>
    <label>Samples before fading:
        <input type="number" id="history-length" value="50" min="1" step="1">
    </label>
</div>
<canvas id="debug-canvas" width="300" height="300"></canvas>
<script>
let SAMPLE_INTERVAL = 5; // milliseconds
let HISTORY_LENGTH = 50;
let debugCanvas, debugCtx;
const samples = [];
let lastSampleTime = 0;

const sampleInput = document.getElementById('sample-interval');
const historyInput = document.getElementById('history-length');
SAMPLE_INTERVAL = parseInt(sampleInput.value, 10) || SAMPLE_INTERVAL;
HISTORY_LENGTH = parseInt(historyInput.value, 10) || HISTORY_LENGTH;
sampleInput.addEventListener('input', e => {
    const val = parseInt(e.target.value, 10);
    if (!isNaN(val) && val > 0) {
        SAMPLE_INTERVAL = val;
    }
});
historyInput.addEventListener('input', e => {
    const val = parseInt(e.target.value, 10);
    if (!isNaN(val) && val > 0) {
        HISTORY_LENGTH = val;
        if (samples.length > HISTORY_LENGTH) {
            samples.length = HISTORY_LENGTH;
        }
        drawTrail();
    }
});

function initDebugCanvas() {
    debugCanvas = document.getElementById('debug-canvas');
    if (debugCanvas) {
        debugCtx = debugCanvas.getContext('2d');
    }
}

function zToColor(z) {
    const clamped = Math.max(-10, Math.min(10, z));
    const hue = ((10 - clamped) / 20) * 240; // blue to red
    return `hsl(${hue}, 100%, 50%)`;
}

function drawTrail() {
    if (!debugCtx) return;
    const w = debugCanvas.width;
    const h = debugCanvas.height;
    debugCtx.clearRect(0, 0, w, h);
    for (let i = samples.length - 1; i >= 0; i--) {
        const { x, y, z } = samples[i];
        const px = (x + 10) / 20 * w;
        const py = (y + 10) / 20 * h;
        const alpha = (i + 1) / HISTORY_LENGTH;
        debugCtx.globalAlpha = alpha;
        debugCtx.fillStyle = zToColor(z);
        debugCtx.beginPath();
        debugCtx.arc(px, h - py, 10, 0, Math.PI * 2);
        debugCtx.fill();
    }
    debugCtx.globalAlpha = 1;
}

function setupMotion() {
    initDebugCanvas();
    window.addEventListener('devicemotion', event => {
        const { x = 0, y = 0, z = 0 } = event.accelerationIncludingGravity || {};
        document.getElementById('x').textContent = x && x.toFixed ? x.toFixed(2) : '0';
        document.getElementById('y').textContent = y && y.toFixed ? y.toFixed(2) : '0';
        document.getElementById('z').textContent = z && z.toFixed ? z.toFixed(2) : '0';

        const now = Date.now();
        if (now - lastSampleTime >= SAMPLE_INTERVAL) {
            lastSampleTime = now;
            samples.unshift({ x, y, z });
            if (samples.length > HISTORY_LENGTH) {
                samples.pop();
            }
        }
        drawTrail();
    });
    document.getElementById('status').textContent = 'Reading accelerometer...';
}

function initMotionAccess() {
    if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
        // iOS 13+
        DeviceMotionEvent.requestPermission().then(response => {
            if (response === 'granted') {
                setupMotion();
            } else {
                document.getElementById('status').textContent = 'Permission denied.';
            }
        }).catch(err => {
            document.getElementById('status').textContent = 'Permission error: ' + err;
        });
    } else if (typeof DeviceMotionEvent !== 'undefined') {
        // Other browsers that support DeviceMotion without explicit permission
        setupMotion();
    } else {
        document.getElementById('status').textContent = 'DeviceMotion not supported.';
    }
}

document.body.addEventListener('touchstart', initMotionAccess, { once: true });
document.body.addEventListener('click', initMotionAccess, { once: true });
document.getElementById('status').textContent = 'Tap anywhere to allow motion access.';
</script>
</body>
</html>

